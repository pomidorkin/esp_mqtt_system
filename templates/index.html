{% extends "base.html" %}

{% block title %}–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ - ESP Manager{% endblock %}
{% block header %}üì± –ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞{% endblock %}
{% block subtitle %}–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ESP —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ —á–µ—Ä–µ–∑ MQTT{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" id="total-devices">0</div>
            <div class="stat-label">–í—Å–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="online-devices">0</div>
            <div class="stat-label">–û–Ω–ª–∞–π–Ω</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="device-types">0</div>
            <div class="stat-label">–¢–∏–ø–æ–≤ —É—Å—Ç—Ä–æ–π—Å—Ç–≤</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="available-rgb">0</div>
            <div class="stat-label">–î–æ—Å—Ç—É–ø–Ω–æ RGB</div>
        </div>
    </div>

    <div class="controls">
        <button class="btn btn-primary" onclick="refreshDevices()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn btn-secondary" onclick="discoverDevices()">üîç –ü–æ–∏—Å–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤</button>
        <button class="btn btn-info" onclick="sendToAll('STATUS')">üì° –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã</button>
        <button class="btn btn-warning" onclick="mixColors()">üé® –ü–µ—Ä–µ–º–µ—à–∞—Ç—å —Ü–≤–µ—Ç–∞</button>
        <button class="btn btn-success" onclick="setAllAvailableColor()">üåà –û–¥–∏–Ω —Ü–≤–µ—Ç –¥–ª—è –≤—Å–µ—Ö</button>
    </div>

    <div class="devices-container">
        <h3>üìã –°–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤</h3>
        <div id="devices-list" class="devices-list">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤...</div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ü–≤–µ—Ç–∞ -->
<div id="colorModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>üé® –í—ã–±–æ—Ä —Ü–≤–µ—Ç–∞</h3>
        <div class="color-picker-container">
            <input type="color" id="colorPicker" value="#ff0000">
            <div class="color-presets">
                <button class="color-preset" style="background: #ff0000;" onclick="setPresetColor('#ff0000')"></button>
                <button class="color-preset" style="background: #00ff00;" onclick="setPresetColor('#00ff00')"></button>
                <button class="color-preset" style="background: #0000ff;" onclick="setPresetColor('#0000ff')"></button>
                <button class="color-preset" style="background: #ffff00;" onclick="setPresetColor('#ffff00')"></button>
                <button class="color-preset" style="background: #ff00ff;" onclick="setPresetColor('#ff00ff')"></button>
                <button class="color-preset" style="background: #00ffff;" onclick="setPresetColor('#00ffff')"></button>
                <button class="color-preset" style="background: #ffffff;" onclick="setPresetColor('#ffffff')"></button>
                <button class="color-preset" style="background: #000000;" onclick="setPresetColor('#000000')"></button>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-primary" onclick="applyColorToDevice()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <button class="btn btn-secondary" onclick="closeColorModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    let currentDeviceId = null;

    // –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    function sendToAll(command) {
        fetch('/api/broadcast', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ command: command })
        })
            .then(response => response.json())
            .then(data => {
                showNotification(`–ö–æ–º–∞–Ω–¥–∞ ${command} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤—Å–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º`, 'success');
                refreshDevices();
            });
    }

    function mixColors() {
        fetch('/api/devices/mix_colors', {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                showNotification(data.message, data.status);
                refreshDevices();
            });
    }

    function setAllAvailableColor() {
        openColorModal('all');
    }

    function openColorModal(deviceId) {
        currentDeviceId = deviceId;
        const modal = document.getElementById('colorModal');
        modal.style.display = 'block';

        if (deviceId === 'all') {
            document.querySelector('.modal-content h3').textContent = 'üé® –í—ã–±–æ—Ä —Ü–≤–µ—Ç–∞ –¥–ª—è –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤';
        } else {
            document.querySelector('.modal-content h3').textContent = `üé® –í—ã–±–æ—Ä —Ü–≤–µ—Ç–∞ –¥–ª—è ${deviceId}`;
        }
    }

    function closeColorModal() {
        const modal = document.getElementById('colorModal');
        modal.style.display = 'none';
        currentDeviceId = null;
    }

    function setPresetColor(color) {
        document.getElementById('colorPicker').value = color;
    }

    function applyColorToDevice() {
        const color = document.getElementById('colorPicker').value;
        const r = parseInt(color.substr(1, 2), 16);
        const g = parseInt(color.substr(3, 2), 16);
        const b = parseInt(color.substr(5, 2), 16);

        console.log("üé® –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞:", { device: currentDeviceId, r, g, b });

        if (currentDeviceId === 'all') {
            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–≤–µ—Ç –¥–ª—è –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            fetch('/api/devices/set_all_color', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ red: r, green: g, blue: b })
            })
                .then(response => response.json())
                .then(data => {
                    console.log("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data);
                    showNotification(data.message, data.status);
                    refreshDevices();
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞:", error);
                    showNotification('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ü–≤–µ—Ç–∞', 'error');
                });
        } else if (currentDeviceId) {
            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–≤–µ—Ç –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            deviceManager.setDeviceColor(currentDeviceId, r, g, b);
        }

        closeColorModal();
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    window.onclick = function (event) {
        const modal = document.getElementById('colorModal');
        if (event.target == modal) {
            closeColorModal();
        }
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–Ω–æ–ø–∫–µ –∑–∞–∫—Ä—ã—Ç–∏—è
    document.querySelector('.close').onclick = closeColorModal;
</script>

<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 20px;
        border-radius: 10px;
        width: 400px;
        max-width: 90%;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

        .close:hover {
            color: black;
        }

    .color-picker-container {
        margin: 20px 0;
        text-align: center;
    }

    #colorPicker {
        width: 100px;
        height: 100px;
        border: none;
        border-radius: 50%;
        cursor: pointer;
    }

    .color-presets {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 10px;
        margin: 15px 0;
    }

    .color-preset {
        width: 30px;
        height: 30px;
        border: 2px solid #ddd;
        border-radius: 50%;
        cursor: pointer;
        transition: transform 0.2s;
    }

        .color-preset:hover {
            transform: scale(1.2);
            border-color: #333;
        }

    .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
    }

    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    .rgb-color-indicator {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
        border: 1px solid #ddd;
    }

    .device-status-badge {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        margin-left: 8px;
    }

    .status-available {
        background: #27ae60;
        color: white;
    }

    .status-pressed {
        background: #e74c3c;
        color: white;
    }
</style>
{% endblock %}